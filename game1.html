<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Skills Game</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
   <style>
    /* ====================================
       1. VARIABILI GLOBALI E FONT BASE
       ==================================== */
    :root {
        --primary-color: #1A3C6B; /* Blu Scuro per testo principale */
        --secondary-color: #E6EBF5; /* Grigio/Blu Chiaro per sfondi */
        --background-color: #F8F9FA; /* Sfondo pagina */
        --card-bg: white;
        --border-radius: 12px;
        --box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        --correct-color: #28a745;
        
        /* Colori delle Card di Ruolo/Settore */
        --card-color-1: #38a7c2; /* Blu (Smart Line Operator) */
        --card-color-2: #e09938; /* Arancione (Plant Flow-Keeper) */
        --card-color-3: #1c4587; /* Blu Scuro (Tech Solver) */
        --banner-color: #6398D5; /* Blu per banner e pulsanti principali */
        --nav-bg: #E6EBF5; 
        --text-color: #333;
    }

    body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--background-color);
        color: var(--primary-color);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        line-height: 1.6;
        padding-bottom: 80px; /* Spazio per il footer fisso */
    }

    .container {
        width: 95%;
        max-width: 1000px;
        min-height: calc(100vh - 80px); 
        text-align: center;
        padding: 0;
        background-color: var(--background-color);
        position: relative;
    }
    
    /* ====================================
       2. LAYOUT E ANIMAZIONI
       ==================================== */
    .page {
        display: none;
        padding: 0 20px; 
        min-height: 80vh;
        animation: fadeIn 0.8s ease-in-out;
    }

    .page.active {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* ====================================
       3. HEADER E FOOTER FISSI
       ==================================== */
    .header-banner {
        width: 100%;
        background-color: var(--banner-color);
        color: white;
        padding: 15px 0;
        text-align: center;
        font-size: 1.2em;
        font-weight: 600;
        margin-bottom: 40px;
        box-shadow: var(--box-shadow);
    }

    .footer-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 70px;
        background-color: white;
        border-top: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 10;
    }

    .nav-button {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f8f8f8;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
        display: flex;
        align-items: center;
    }

    .nav-button.home-btn {
        background-color: var(--banner-color);
        color: white;
        border: none;
        padding: 10px;
    }

    .nav-button.continue-btn {
        background-color: var(--banner-color);
        color: white;
        border: none;
        padding: 10px 20px;
    }
    
    /* Stili per il testo e gli input */
    .page h2 {
        font-size: 2em;
        color: var(--primary-color);
        margin-top: 40px;
        margin-bottom: 10px;
    }
    
    .page p.subtitle {
        color: #666;
        margin-bottom: 40px;
    }
    
    /* ====================================
       4. PROGRESSIONE (SLIDER)
       ==================================== */
    .pagination-dots {
        display: flex;
        gap: 8px;
        margin: 0 20px;
    }

    .dot {
        width: 8px;
        height: 8px;
        background-color: var(--nav-bg); 
        border-radius: 50%;
        transition: all 0.3s ease-in-out;
    }

    .dot.active {
        width: 25px; /* Estensione per l'effetto slider */
        border-radius: 5px; /* Forma a pillola */
        background-color: var(--banner-color); 
        transform: none;
    }

    /* ====================================
       5. CARD RUOLI E CONTESTI
       ==================================== */
    .card-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px; /* Spaziatura corretta per 3 colonne */
        width: 100%;
        margin-top: 20px;
        justify-content: center;
    }

    .role-card-style, .sector-card-style {
        background-color: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
        transition: all 0.3s ease-in-out;
        border: 3px solid transparent; 
        cursor: pointer;
        width: 100%; /* Occupa l'intera griglia */
    }
    
    .role-card-style.selected, .sector-card-style.selected {
        border: 3px solid var(--primary-color);
        transform: translateY(-5px);
    }

    .role-header, .sector-header {
        height: 200px; 
        padding: 20px;
        color: white;
        font-weight: 600;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
        text-align: center;
    }
    
    /* Colori */
    .role-color-1 { background-color: #38a7c2; }
    .role-color-2 { background-color: #e09938; }
    .role-color-3 { background-color: #1c4587; }
    
    .sector-color-1 { background-color: #9283c7; } /* Settore food */
    .sector-color-2 { background-color: #9283c7; } /* Settore auto */
    .sector-color-3 { background-color: #9283c7; } /* Settore logistica */
    
    /* ====================================
       6. SKILLS BOX
       ==================================== */
    .skill-box-container {
        width: 100%;
        max-width: 900px;
        background-color: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-top: 30px;
        text-align: left;
    }
    
    .skills-list {
        display: grid;
        grid-template-columns: repeat(2, 1fr); 
        gap: 15px 30px;
    }
    
    .skills-list.four-columns {
        grid-template-columns: repeat(4, 1fr);
        gap: 5px 5px; 
        padding: 0 5px; 
    }
    
    .skills-list label {
        font-size: 0.85em; 
        padding: 5px 0;
        display: flex;
        align-items: center;
        color: var(--primary-color);
    }
    </style>
</head>
<body>

    <div class="container">
        <span class="back-button" onclick="goBack()">&larr;</span>

        <div id="intro" class="page active">
            <h1>Operator Skills Game</h1>
            <p id="intro-text">Are you curious to learn more about the impact of Industry 5.0 technologies on people? <br>
                The role of humans will evolve, and new skills will be required.
                Press Start and discover how much you know about this topic.</p>
            <button class="btn" onclick="nextPage('role-selection')">START</button>
        </div>

        <div id="role-selection" class="page">
            <div class="header-banner">Choose the role: <br> Select the role to interpret</div>
            <div class="card-group">
                <div class="role-card-style" onclick="selectRole('Operator', this)">
                    <div class="role-header role-color-1 color-1"> <div class="image-placeholder"></div>
                        <h3>SMART LINE OPERATOR</h3>
                    </div>
                    <div class="role-body">
                        <p>Works alongside robots in shared areas, supervises their operations, and performs basic troubleshooting. As robots handle the most manual and repetitive tasks, this role requires broader skills than before, especially technical, analytical, and collaboration skills.</p>
                    </div>
                </div>
                </div>
            <div class="pagination-dots"></div>
            <button class="btn nav-button continue-btn" id="confirm-role-btn" onclick="nextPage('context-selection')" style="display: none;">Continue ></button>
        </div>

                <div class="role-card-style" onclick="selectRole('Supervisor', this)">
                    <div class="role-header color-2">
                        <div class="image-placeholder"></div>
                        <h3>PLANT FLOW-KEEPER</h3>
                    </div>
                    <div class="role-body">
                        <p>Manages and coordinates the team and work area, supervises production flows, supports operators and robots, and ensures process efficiency. The role combines strong management, technical, operational, and analytical skills to plan activities, resolve medium-level issues, and maintain smooth and safe production operations.</p>
                    </div>
                </div>

                <div class="role-card-style" onclick="selectRole('Maintenance technician', this)">
                    <div class="role-header color-3">
                        <div class="image-placeholder"></div>
                        <h3>TECH SOLVER</h3>
                    </div>
                    <div class="role-body">
                        <p>Acts as the reference for programming robots, configuring systems to optimise production processes, performing maintenance, and solving technical issues. Requires strong technical skills on new programming codes and solid analytical skills.</p>
                    </div>
                </div>
            </div>
            <div class="pagination-dots"></div>
            <button class="btn" id="confirm-role-btn" onclick="nextPage('context-selection')" style="display: none;">CONFERMA</button>
        </div>
        
        <div id="context-selection" class="page">
            <h2>Scegli un contesto lavorativo:</h2>
            <div class="card-group">
                <div class="card" onclick="selectContext('Food Sector', this)">
                    <div class="placeholder"></div>
                    <h3>Food Sector</h3>
                    <p>Short description...</p>
                </div>
                <div class="card" onclick="selectContext('Automotive Sector', this)">
                    <div class="placeholder"></div>
                    <h3>Automotive Sector</h3>
                    <p>Short description...</p>
                </div>
                <div class="card" onclick="selectContext('Logistic Sector', this)">
                    <div class="placeholder"></div>
                    <h3>Logistic Sector</h3>
                    <p>Short description...</p>
                </div>
            </div>
            <div class="pagination-dots"></div>
            <button class="btn" id="confirm-context-btn" onclick="showScenario(gameState.context)" style="display: none;">CONFERMA</button>
        </div>
        
        <div id="scenario-details" class="page">
            <h2 id="scenario-title"></h2>
            <div class="scenario-card-large">
                <div class="scenario-details">
                    <div class="placeholder"></div>
                    <h3 id="role-name-display"></h3>
                    <p id="role-description-display"></p>
                </div>
                <div class="task-list">
                    <h3 id="scenario-name-display"></h3>
                    <h4 id="task-list-title">Lista dei task</h4>
                    <ul id="task-list-display"></ul>
                </div>
            </div>
            <div class="pagination-dots"></div>
            <button class="btn" onclick="nextPage('skills-selection')">INIZIA</button>
        </div>

        <div id="skills-selection" class="page">
            <h2 id="skills-question">Seleziona le skills che secondo te permettono a [nome] di poter lavorare in [nome scenario]:</h2>
            <div class="skills-container">
                <div class="arrow" onclick="prevCategory()">&lt;</div>
                <div class="skills-category">
                    <h4 id="skills-category-title"></h4>
                    <form id="skills-form">
                        <div class="skills-list"></div>
                        <button class="btn" type="submit" style="display: none;"></button>
                    </form>
                </div>
                <div class="arrow" onclick="nextCategory()">&gt;</div>
            </div>
            <div class="pagination-dots"></div>
            <button class="btn" id="confirm-skills-btn" onclick="nextPage('results')" style="display: none;">CONFERMA</button>
        </div>

        <div id="results" class="page">
            <h2 id="results-title">I tuoi risultati</h2>
            <div class="results-container">
                <div class="scenario-details">
                    <div class="placeholder"></div>
                    <h3 id="results-role-name"></h3>
                    <p id="results-role-description"></p>
                </div>
                <div class="score-card">
                    <h3>Punteggio</h3>
                    <div id="score-details"></div>
                    <div id="final-score" class="final-score">Final score: 60% correct answers</div>
                </div>
            </div>
            <div class="pagination-dots"></div>
            <button class="btn" onclick="nextPage('job-info-final')">NEXT</button>
        </div>

        <div id="job-info-final" class="page">
            <h2 id="job-title-final">Salva i tuoi risultati</h2>
            <div class="input-group">
                <label for="job-final">Job *</label>
                <input type="text" id="job-final" required>
            </div>
            <div class="input-group">
                <label for="country-final">Country where you work *</label>
                <input type="text" id="country-final" required>
            </div>
            <button class="btn" onclick="saveDataAndReset()">SAVE</button>
        </div>

        <div id="loading" class="page">
            <h2>Loading...</h2>
        </div>
    </div>

    <script>
        // ====================================
        // 1. DATI GLOBALI
        // ====================================
        const allSkills = {
            "Personal/Soft": ["Meet commitments", "Adapting to changing situations", "Physical strenght", "Managing stressful or challenging conditions", "Observation skills", "Manual Dexterity", "Responsiveness"],
            "Management": ["Monitoring warehouse security procedures", "Monitoring workers' safety on the production floor", "Safety checking", "Risk assessment", "Supervising staff", "Team management", "Conflict resolution", "Task/Production planning"],
            "Collab/Comm": ["Avoid collision with AI", "Assign and manage tasks", "Provide feedback to AI systems", "Understand AI-generated insights", "Assisting others in complex situations", "Coordination with the robot work", "Coordination across operators", "System/Machine reports understanding", "Revising algorithm's suggestion"],
            "Interaction/UX": ["Use voice commands", "Interact physically with cobots", "Use of production monitoring dashboard", "Respond to haptic feedback", "Use gesture-based controls", "Collaborating with robots in shared spaces", "Use of touchscreen-based interface", "Ure AR devices for real-time and visual guidance"],
            "Analytical": ["Preventive maintenance", "Predictive maintenance", " Problem identification", "Risk assessment", "Making time-critical decisions", "Decision making", "Data interpretation", "Problem Solving"],
            "Technical": ["Process awareness", "Technical issues resolution", "Digital system usage", "Digital data management", "System state interpretation", "Technical inspection", "Problem/Alert management", "Algorithms output understanding", "Quality assessment","Setting up the activity", "Statistical process control", "Understanding AI systems", "Data processing", "Knowledge of Machine/Robot task", "Machine/Robot maintenance","Machine/Robot setting parameters", "Turning on machines/robot", "Use of the Robot controller", "Understanding the Robot coding/language", "Knowledge of robot mechanisms", "Setting up the robot", "Robot programming", "Understand the robot feedback", "Know how to interact with robots", "Coding"],
            "Operational": ["Procedures knowledge of error situation", "Task knowledge", "Time Management", "Coping with pressure", "Situational awareness", "Fast task execution", "Procedure Knowledge", "Handling unexpected events and emergencies"]
        };

        const correctSkillsData = {
            "Automotive Sector": {
                "Operator": ["Task knowledge", "Procedures knowledge of error situation", "Situational awareness", "Use of the Robot controller", "Process awareness", "Understand the robot feedback", "Know how to interact with robots", "Technical issues resolution", "Knowledge of Machine/Robot task", "Coordination with the robot work", "Collaborate with robotic systems in shared workspaces"],
                "Supervisor": ["Know how to interact with robots", "Use of the Robot controller", "Understand the robot feedback", "Handling unexpected events and emergencies", "Coordination across operators", "Conflict resolution", "Team management", "Supervising staff", "Monitoring security procedures in warehouse operations"],
                "Maintenance technician": ["Knowledge of robot mechanisms", "Robot programming", "Know how to interact with robots", "Use of the Robot controller", "Understand the robot feedback", "Technical issues resolution", "Technical inspection", "Interact physically with cobots", "Problem identification"]
            },
            "Food Sector": {
                "Operator": ["System state interpretation", "Turning on machines/robot", "Setting up the robot", "Problem / Alert management", "Quality assessment", "Use of the Robot controller", "Understand the robot feedback", "Process awareness", "Digital systems usage", "Know how to interact with robots", "Coordination with the robot work", "Situational awareness", "Task knowledge", "Procedures knowledge", "Procedures knowledge of error situation", "Production monitoring", "Collaborate with robotic systems in shared workspaces"],
                "Supervisor": ["Task/Production planning", "Safety checking", "Setting up the activity", "Machine/Robot setting parameters", "Digital systems usage", "Risk assessment", "Problem identification", "Task knowledge", "Handling unexpected events and emergencies"],
                "Maintenance technician": ["Technical inspection", "Use of the robot controller", "Data interpretation", "Knowledge of robot mechanisms", "Know how to interact with robots", "Robot programming", "Technical issues resolution", "Understand the robot feedback", "Problem identification"]
            },
            "Logistic Sector": {
                "Operator": ["Task knowledge", "Procedures knowledge of error situation", "Use of the Robot controller", "Problem / Alert management", "Setting up the activity", "System state interpretation", "Machine/robot setting parameters", "Process awareness", "Know how to interact with robots", "Task/Production planning", "Safety checking", "Decision making", "Problem solving", "Problem identification", "Data interpretation", "Coordination with the robot work"],
                "Supervisor": ["Task/Production planning", "Alert management", "Safety checking", "Data interpretation", "Decision Making"],
                "Maintenance technician": ["Predictive maintenance", "Data interpretation", "Use of the robot controller", "Setting up the robot", "Machine/robot setting parameters", "Understanding the Robot coding/language", "Technical inspection", "Algorithms output understanding", "Knowledge of robot mechanisms", "Digital System/Machine/Robot automatic reports understanding", "Alert management", "Safety checking", "Interact physically with cobots", "Understand the robot feedback"]
            }
        };

        const scenarios = {
            "Automotive Sector": {
                tasks: ["Scrivere codice pulito", "Risolvere bug", "Collaborare in team", "Analizzare dati di produzione", "Gestire la supply chain"],
                highlightedTasks: {
                    "Operator": ["Scrivere codice pulito", "Risolvere bug"],
                    "Supervisor": ["Collaborare in team", "Analizzare dati di produzione"],
                    "Maintenance technician": ["Risolvere bug"]
                }
            },
            "Food Sector": {
                tasks: ["Pianificare campagne", "Analizzare dati di mercato", "Gestire budget"],
                highlightedTasks: {
                    "Operator": ["Pianificare campagne", "Analizzare dati di mercato"],
                    "Supervisor": ["Gestire budget", "Analizzare dati di mercato"],
                    "Maintenance technician": ["Pianificare campagne"]
                }
            },
            "Logistic Sector": {
                tasks: ["Gestire il magazzino", "Pianificare le spedizioni", "Ottimizzare i percorsi"],
                highlightedTasks: {
                    "Operator": ["Gestire il magazzino"],
                    "Supervisor": ["Pianificare le spedizioni"],
                    "Maintenance technician": ["Ottimizzare i percorsi"]
                }
            }
        };
        const roles = {
            "Operator": { name:"Operator", description_as_is: "Ruolo focalizzato sull'operatività di base.", to_be_name : "Smart Line Operator", to_be_description: `Works alongside robots in shared areas,
                            supervises their operations, and performs basic troubleshooting. As robots handle the most manual and repetitive tasks, this role requires broader skills than before, especially technical, analytical, and collaboration skills.` },
            "Supervisor": { name:"Supervisor", description_as_is: "Ruolo di supervisione delle attività e del personale.", to_be_name : "Plant Flow-Keeper", to_be_description: `Manages and coordinates the team and work
                            area, supervises production flows, supports operators and robots, and ensures process efficiency. The role combines strong management, technical, operational, and
                            analytical skills to plan activities, resolve medium-level issues, and maintain smooth and safe production operations.` },
            "Maintenance technician": { name: "Maintenance technician", description_as_is: "Ruolo di manutenzione e riparazione di attrezzature.", to_be_name: "Tech Solver", to_be_description: `Acts as the reference for programming robots,
                            configuring systems to optimise production processes, performing maintenance, and solving technical issues. Requires strong technical skills on new programming codes and solid analytical skills.` },
        };

        let gameState = {
            currentPage: 'intro',
            history: ['intro'],
            user: { job: '', country: '' },
            role: null,
            context: null,
            scenario: null,
            skills: { selected: {}, correct: {} }
        };
        let currentSkillCategory = 0;
        const skillCategories = Object.keys(allSkills);
        const progressPages = ['role-selection', 'context-selection', 'scenario-details', 'skills-selection', 'results', 'job-info-final'];


        // ====================================
        // 2. FUNZIONI DI NAVIGAZIONE E FLUSSO
        // ====================================
        
        function updatePagination() {
            const dotsContainers = document.querySelectorAll('.pagination-dots');
            if (dotsContainers.length === 0) return;

            const totalSteps = progressPages.length;
            const currentStepIndex = progressPages.indexOf(gameState.currentPage);

            dotsContainers.forEach(container => {
                container.innerHTML = '';
                if (currentStepIndex >= 0) { 
                    for (let i = 0; i < totalSteps; i++) {
                        const dot = document.createElement('div');
                        dot.classList.add('dot');
                        if (i === currentStepIndex) {
                            dot.classList.add('active');
                        }
                        container.appendChild(dot);
                    }
                }
            });
        }
        
        function renderPage() {
            const allPageIds = ['intro', 'role-selection', 'context-selection', 'scenario-details', 'skills-selection', 'results', 'job-info-final', 'loading'];
            allPageIds.forEach(id => {
                const pageElement = document.getElementById(id);
                if (pageElement) {
                    pageElement.classList.remove('active');
                }
            });
            const currentPageElement = document.getElementById(gameState.currentPage);
            if (currentPageElement) {
                currentPageElement.classList.add('active');
            }
            
            const backButton = document.querySelector('.back-button');
            if (backButton) {
                backButton.style.display = gameState.currentPage === 'intro' ? 'none' : 'block';
            }
            updatePagination();
        }

        function nextPage(pageId) {
            gameState.history.push(gameState.currentPage);
            gameState.currentPage = pageId;
            renderPage();
            if (pageId === 'skills-selection') {
                renderSkills();
            } else if (pageId === 'results') {
                showResults();
            } else if (pageId === 'job-info-final') {
                // Pre-compila i campi con i dati salvati o vuoti
                document.getElementById('job-final').value = gameState.user.job || '';
                document.getElementById('country-final').value = gameState.user.country || '';
            }
        }

        function goBack() {
            if (gameState.history.length > 1) {
                gameState.currentPage = gameState.history.pop();
                renderPage();
            }
        }

        // ====================================
        // 3. FUNZIONI DI SCELTA
        // ====================================

        function clearSelection(className) {
            const cards = document.querySelectorAll('.role-card-style, .card'); 
            cards.forEach(card => card.classList.remove('selected'));
        }

        function selectRole(role, element) {
            clearSelection('role-card-style'); 
            element.classList.add('selected');
            gameState.role = role;
            document.getElementById('confirm-role-btn').style.display = 'block';
            console.log("Ruolo selezionato:", role);
        }

        function selectContext(context, element) {
            clearSelection('card');
            element.classList.add('selected');
            gameState.context = context;
            document.getElementById('confirm-context-btn').style.display = 'block';
            console.log("Contesto selezionato:", context);
        }
        
        function showScenario(scenario) {
            gameState.scenario = scenario;
            const scenarioData = scenarios[scenario];
            const roleData = roles[gameState.role];

            document.getElementById('role-name-display').textContent = gameState.role;
            document.getElementById('role-description-display').textContent = roleData.description_as_is;
            document.getElementById('scenario-name-display').textContent = scenario;

            const taskList = document.getElementById('task-list-display');
            taskList.innerHTML = '';
            
            const highlightedTasks = scenarioData.highlightedTasks[gameState.role] || [];

            highlightedTasks.forEach(task => {
                const li = document.createElement('li');
                li.textContent = task;
                li.classList.add('highlighted');
                taskList.appendChild(li);
            });

            nextPage('scenario-details');
        }
        
        // ====================================
        // 4. FUNZIONI SKILLS
        // ====================================
        
        function renderSkills() {
            const categoryName = skillCategories[currentSkillCategory];
            const skills = allSkills[categoryName];

            document.getElementById('skills-category-title').textContent = categoryName;
            const skillsListDiv = document.querySelector('#skills-form .skills-list');
            skillsListDiv.innerHTML = '';

            // LOGICA DI CONTROLLO DELLE COLONNE
            if (categoryName === 'Technical') {
                skillsListDiv.classList.add('four-columns');
            } else {
                skillsListDiv.classList.remove('four-columns');
            }

            skills.forEach(skill => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" name="skill" value="${skill}"> ${skill}`;
                skillsListDiv.appendChild(label);
                
                if (gameState.skills.selected[categoryName] && gameState.skills.selected[categoryName].includes(skill)) {
                    label.querySelector('input').checked = true;
                }
            });

            document.getElementById('skills-question').innerHTML = `Seleziona le skills che secondo te permettono a **${roles[gameState.role].to_be_name}** di poter lavorare nel settore **${gameState.context}**:`;
            
            const prevArrow = document.querySelector('.skills-container .arrow:first-child');
            const nextArrow = document.querySelector('.skills-container .arrow:last-child');
            if (prevArrow) prevArrow.style.visibility = currentSkillCategory === 0 ? 'hidden' : 'visible';
            if (nextArrow) nextArrow.style.visibility = currentSkillCategory === skillCategories.length - 1 ? 'hidden' : 'visible';

            const confirmBtn = document.getElementById('confirm-skills-btn');
            if (confirmBtn) {
                confirmBtn.style.display = currentSkillCategory === skillCategories.length - 1 ? 'block' : 'none';
            }
        }

        function nextCategory() {
            saveSkills();
            if (currentSkillCategory < skillCategories.length - 1) {
                currentSkillCategory++;
                renderSkills();
            } else {
                nextPage('results');
            }
        }

        function prevCategory() {
            if (currentSkillCategory > 0) {
                saveSkills();
                currentSkillCategory--;
                renderSkills();
            }
        }

        function saveSkills() {
            const selected = Array.from(document.querySelectorAll('#skills-form input[name="skill"]:checked'))
                             .map(input => input.value);
            const categoryName = skillCategories[currentSkillCategory];
            gameState.skills.selected[categoryName] = selected;
        }

        // ====================================
        // 5. FUNZIONI RISULTATI E SALVATAGGIO
        // ====================================

        function showResults() {
            const role = gameState.role;
            const scenario = gameState.context;

            const correctSkills = correctSkillsData[scenario][role] || [];
            
            let totalCorrectAnswers = 0;
            let totalPossibleAnswers = 0;

            const scoreDetailsDiv = document.getElementById('score-details');
            scoreDetailsDiv.innerHTML = '';

            skillCategories.forEach(categoryName => {
                const selected = gameState.skills.selected[categoryName] || [];
                
                const userCorrectInCat = selected.filter(s => correctSkills.includes(s)).length;
                const totalCorrectInCat = allSkills[categoryName].filter(s => correctSkills.includes(s)).length;

                const percentage = totalCorrectInCat > 0 ? Math.round((userCorrectInCat / totalCorrectInCat) * 100) : 0;
                
                totalCorrectAnswers += userCorrectInCat;
                totalPossibleAnswers += totalCorrectInCat;

                const scoreItem = document.createElement('div');
                scoreItem.classList.add('score-item');
                scoreItem.innerHTML = `
                    <div class="score-label">
                        <span>${categoryName}</span>
                        <span style="color: ${percentage >= 70 ? 'var(--correct-color)' : percentage > 30 ? '#ffc107' : 'var(--wrong-color)'};">${percentage}%</span>
                    </div>
                    <div class="score-bar">
                        <div style="width: ${percentage}%; background-color: ${percentage >= 70 ? 'var(--correct-color)' : percentage > 30 ? '#ffc107' : 'var(--wrong-color)'};"></div>
                    </div>
                `;
                scoreDetailsDiv.appendChild(scoreItem);
            });

            const finalPercentage = totalPossibleAnswers > 0 ? Math.round((totalCorrectAnswers / totalPossibleAnswers) * 100) : 0;
            document.getElementById('final-score').textContent = `Final score: ${finalPercentage}% correct answers`;

            const scenarioData = scenarios[scenario];
            const roleData = roles[role];
            
            if (scenarioData && roleData) {
                document.getElementById('results-role-name').textContent = roleData.to_be_name;
                document.getElementById('results-role-description').textContent = roleData.to_be_description;
                document.getElementById('results-scenario-name').textContent = `Nome scenario: ${scenario}`;
                const taskList = document.getElementById('results-task-list-display');
                if (taskList) {
                    taskList.innerHTML = '';
                    const highlightedTasks = scenarioData.highlightedTasks[role] || [];
                    highlightedTasks.forEach(task => {
                        const li = document.createElement('li');
                        li.textContent = task;
                        li.classList.add('highlighted');
                        taskList.appendChild(li);
                    });
                }
            }
        }
        
        function saveDataAndReset() {
            const job = document.getElementById('job-final').value;
            const country = document.getElementById('country-final').value;

            if (!job || !country) {
                alert("Per favore, inserisci tutte le informazioni richieste.");
                return;
            }

            const finalData = {
                job: job,
                country: country,
                context: gameState.context,
                role: gameState.role,
                scenario: gameState.scenario,
                selectedSkills: gameState.skills.selected,
                finalScore: document.getElementById('final-score').textContent,
                timestamp: new Date().toISOString()
            };
            
            fetch('https://career-skills-game-1.onrender.com/updatechart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(finalData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("Dati salvati con successo sul server:", data.message);
                    startNewSession();
                } else {
                    console.error("Errore del server:", data.message);
                    alert("Errore nel salvataggio dei dati.");
                }
            })
            .catch((error) => {
                console.error('Errore di comunicazione:', error);
                alert("Si è verificato un errore di comunicazione con il server.");
            });
        }

        function startNewSession() {
            gameState = {
                currentPage: 'intro',
                history: ['intro'],
                user: { job: '', country: '' },
                role: null,
                context: null,
                scenario: null,
                skills: { selected: {}, correct: {} }
            };
            currentSkillCategory = 0;

            renderPage();
        }

        // ====================================
        // 6. INIZIALIZZAZIONE
        // ====================================

        function initializeApp() {
             fetch('https://career-skills-game-1.onrender.com/csvloading')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log(data.message);
                    }
                })
                .catch(error => {
                    console.error('Errore durante il controllo del file CSV:', error);
                });
            renderPage();
        }

        initializeApp();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(registration => {
                    console.log('Service Worker registrato con successo:', registration);
                }).catch(error => {
                    console.log('Registrazione Service Worker fallita:', error);
                });
            });
        }
    </script>
</body>
</html>